node { 

def VAULT_ADDR = 'https://vault.ocp4.example.com:8200'
def VAULT_PATH_SSH = 'secrets/creds/example'

def secrets = [
        [
            path: "${VAULT_PATH_SSH}", engineVersion: 1,
            secretValues: [
                [vaultKey: 'user'], [vaultKey: 'secret'], [vaultKey: 'username']
            ]
        ]
 ]

def configuration = [
       vaultUrl: "${VAULT_ADDR}",
       vaultCredentialId: 'vault-jenkin-role',
       engineVersion: 2
]       
 stage("Checkout SCM") {
        cleanWs()
        checkout scm
 }

 withVault([configuration: configuration, vaultSecrets: secrets]) {
       stage("Run playbook") {
              sh '''
              cat <<EOT > extra_var.yaml
user: ${username}
pass: ${secret}
              '''
              sh "cat extra_var.yaml" 

              sh """
                    ansible-playbook -i inventory --extra-vars @extra_var.yaml  window.yaml
              """
       }
    }

}
