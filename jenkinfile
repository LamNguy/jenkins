node { 

def VAULT_ADDR = 'https://vault.ocp4.example.com:8200'
def VAULT_PATH_SSH = ''

def secrets = [
        [
            path: "${VAULT_PATH_SSH}", engineVersion: 2,
            secretValues: [
                [vaultKey: 'window_os_user'], [vaultKey: 'window_os_pass']
            ]
        ]
 ]

def configuration : LinkedHashMap = [
       vaultUrl: "${VAULT_ADDR}",
       vaultCredentialId: 'jenkins-role',
       engineVersion: 2
]       
 stage("Checkout SCM") {
        cleanWs()
        checkout scm
 }

 withVault([configuration: configuration, vaultSecrets: secrets]){
            stage("Run playbook") {
                sh '''
                cat <<EOT > extra_var.yaml
window_os_user: ${window_os_user}
window_os_pass: ${window_os_pass}
nexus_user: ${NEXUS_USER}
nexus_password: ${NEXUS_PASSWORD}
                '''
                sh "cat extra_var.yaml"
                sh """
                    ansible-playbook -i inventory/hosts_window --extra-vars @extra_var.yaml --extra-vars "nexus_addr=${NEXUS_ADDR}" window.yaml
                """
            }
        }

}
